---
title: eemR 1.0.0
author: Philippe Massicotte
date: '2019-06-14'
tags:
  - R
  - Fluorescence
  - Spectrofluorometer
  - EEMs
  - PARAFAC
---



<p>When <code>eemR</code> was originally created, I wrote few functions to import eems derived from the spectrofluorometers I knew. Given the high diversity in file formats, <code>eemR</code> now offers the possibility for the user to write his/her own import function.</p>
<div id="an-example" class="section level2">
<h2>An example</h2>
<p>In this example, we will learn how to create a import function for a specific eem file generated by the software of a Cary Eclipse spectrofluorometer. First, lets have a look to the content of <code>custom_cary.csv</code>.</p>
<pre class="r"><code>file &lt;- system.file(&quot;extdata/custom_cary.csv&quot;, package = &quot;eemR&quot;)

cat(readLines(file, n = 5), sep = &quot;\n&quot;)</code></pre>
<pre><code>Wavelength (nm),Intensity (a.u.),Z Axis,
,01_SYN_50.00,01_SYN_55.00,01_SYN_60.00,01_SYN_65.00,01_SYN_70.00,01_SYN_75.00,01_SYN_80.00,01_SYN_85.00,01_SYN_90.00,01_SYN_95.00,01_SYN_100.00,01_SYN_105.00,01_SYN_110.00,01_SYN_115.00,01_SYN_120.00,01_SYN_125.00,01_SYN_130.00,01_SYN_135.00,01_SYN_140.00,01_SYN_145.00,01_SYN_150.00,01_SYN_155.00,01_SYN_160.00,01_SYN_165.00,01_SYN_170.00,01_SYN_175.00,01_SYN_180.00,01_SYN_185.00,01_SYN_190.00,01_SYN_195.00,01_SYN_200.00,01_SYN_205.00,01_SYN_210.00,01_SYN_215.00,01_SYN_220.00,01_SYN_225.00,01_SYN_230.00,01_SYN_235.00,01_SYN_240.00,01_SYN_245.00,01_SYN_250.00,01_SYN_255.00,01_SYN_260.00,01_SYN_265.00,01_SYN_270.00,01_SYN_275.00,01_SYN_280.00,01_SYN_285.00,01_SYN_290.00,01_SYN_295.00,01_SYN_300.00,01_SYN_305.00,01_SYN_310.00,01_SYN_315.00,01_SYN_320.00,01_SYN_325.00,01_SYN_330.00
,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57
250,1.85870516300201,2.80107355117798,3.22146272659302,3.60980105400085,4.71845960617065,5.5966010093689,6.45598602294922,7.89595937728882,10.0022115707397,12.8900260925293,16.6048526763916,21.7009887695313,26.7308120727539,33.5129280090332,39.6480255126953,46.94189453125,52.1451263427734,59.4381446838379,63.8430557250977,71.0080108642578,74.9123001098633,80.2605209350586,84.8504257202148,87.1108627319336,87.6054077148438,89.1303558349609,88.1718978881836,89.9914093017578,90.4588851928711,90.4412231445313,91.7687301635742,88.9126510620117,88.2239227294922,83.9044876098633,81.0552597045898,76.6695327758789,72.4987258911133,68.7890853881836,65.8365325927734,91.5800476074219,109.421615600586,93.5778274536133,53.0399932861328,44.5870552062988,40.4739570617676,37.5545845031738,33.1918907165527,30.9178428649902,30.7513618469238,28.8479671478271,26.2540702819824,22.5371971130371,19.1686763763428,16.6529712677002,14.7242202758789,13.7677135467529,12.4740467071533
252.029998779297,2.1434018611908,3.11827969551086,3.62917947769165,4.18700551986694,5.13205671310425,6.11557626724243,7.16383838653564,8.7924222946167,10.8015441894531,13.4013109207153,17.4247570037842,22.7168807983398,28.294412612915,34.4576759338379,40.9357948303223,47.6901092529297,52.4071464538574,59.475528717041,64.4546813964844,70.2739791870117,75.7940139770508,79.9471435546875,83.4396667480469,85.106819152832,85.8016052246094,88.5793075561523,89.0074234008789,90.2360687255859,89.7650833129883,89.8542327880859,89.0672988891602,86.7302703857422,85.7473220825195,82.5640640258789,78.6254653930664,74.7004547119141,70.4368133544922,66.7534103393555,63.1299095153809,68.2004776000977,97.5321884155273,110.740531921387,60.1052017211914,44.5394287109375,39.8698654174805,36.2816505432129,33.5453300476074,30.2543392181396,28.1765575408936,25.9400939941406,25.5557174682617,22.9261245727539,18.3974666595459,15.442798614502,14.079273223877,13.2750692367554,11.3828964233398</code></pre>
<p>From this output, we see that:</p>
<ol style="list-style-type: decimal">
<li>The emission wavelengths are contained in the first column (250, 252, …).</li>
<li>The excitation wavelengths are in the first row (50, 55, …). They are offsets to be applied to each excitation. For examples:
<ul>
<li>The emissions at excitation 250 nm are 250 + 50, 250 + 55, 250 + 60, …</li>
<li>The emissions at excitation 252 nm are 252 + 50, 252 + 55, 252 + 60, …</li>
</ul></li>
<li>The fluorescence data start at row 3 and column 2.</li>
</ol>
<p>The first thing we need to do is to create a function that will read this data in a format that can be used by <code>eemR</code>. <strong>The function needs to meet these flowing criteria:</strong></p>
<ol style="list-style-type: decimal">
<li>Have an argument <code>file</code> that will contains the path of the file(s) to read.</li>
<li>Return a list containing the flowing elements:
<ul>
<li><code>file</code>: the path of the file</li>
<li><code>em</code>: a numeric vector containing emission wavelengths.</li>
<li><code>ex</code>: a numeric vector containing excitation wavelengths.</li>
<li><code>x</code>: a matrix of <code>length(em)</code> rows by <code>length(ex)</code> columns.</li>
</ul></li>
</ol>
<p>Further more, the <code>x</code> matrix of the list need to be arranged as follow:</p>
<p><img src="/post/2019-06-14-eemr-1-0-0.en_files/matrix.png" /></p>
<p>Let’s now write a function that will read the eem file and format the data accordingly. In this particular example, fluorescence has been measured in asynchronous mode. Hence, extra manipulations are needed to get the data on a regular grid.</p>
<pre class="r"><code>library(dplyr)
library(tidyr)
library(eemR)

import_cary &lt;- function(file) {
  dat &lt;- read.csv(file, nrows = 102, skip = 1)

  ex &lt;- na.omit(dat[, 1])
  em &lt;- seq(50, 330, by = 5)

  em &lt;- outer(ex, em, &quot;+&quot;)
  em &lt;- as.vector(em)
  ex &lt;- rep(ex, 57)

  x &lt;- dat[, -1]
  x &lt;- x[-1, ]
  x &lt;- matrix(as.numeric(unlist(x, use.names = FALSE)), ncol = 101, byrow = FALSE)

  res &lt;- tibble(ex, em, x = as.vector(x)) %&gt;%
    arrange(ex, em) %&gt;%
    complete(ex, em, fill = list(x = NA))

  ex &lt;- sort(unique(ex))
  em &lt;- sort(unique(em))
  x &lt;- matrix(res$x, ncol = length(ex), byrow = TRUE)

  # We need to interpolate because you do not have a regular grid (i.e. asynchronous)
  r &lt;- MBA::mba.surf(res %&gt;% drop_na(), no.X = 200, no.Y = 200, extend = FALSE)

  l &lt;- list(
    file = file,
    x = t(r$xyz.est$z),
    ex = r$xyz.est$x,
    em = r$xyz.est$y
  )

  return(l)
}</code></pre>
<p>We can now try our function and have a look to the structure of the returned list.</p>
<pre class="r"><code>str(import_cary(file))</code></pre>
<pre><code>## List of 4
##  $ file: chr &quot;/home/pmassicotte/R/x86_64-pc-linux-gnu-library/3.6/eemR/extdata/custom_cary.csv&quot;
##  $ x   : num [1:200, 1:200] 1.91 2.29 2.73 3.04 3.27 ...
##  $ ex  : num [1:200] 250 251 252 253 254 ...
##  $ em  : num [1:200] 300 302 305 307 310 ...</code></pre>
<p>We will use the <code>import_function</code> argument of the <code>eem_read()</code> function to tell <code>eemR</code> how to read our file.</p>
<pre class="r"><code>eem &lt;- eem_read(file, import_function = import_cary)

eem</code></pre>
<pre><code>##        sample ex_min ex_max em_min em_max is_blank_corrected
## 1 custom_cary    250    450    300    780              FALSE
##   is_scatter_corrected is_ife_corrected is_raman_normalized
## 1                FALSE            FALSE               FALSE</code></pre>
<p>We can visualize the eem by using the <code>plot()</code> function:</p>
<pre class="r"><code>plot(eem)</code></pre>
<p><img src="/post/2019-06-14-eemr-1-0-0.en_files/figure-html/unnamed-chunk-5-1.png" width="768" /></p>
<p>All other functions of the <code>eemR</code> package can now be used on the created <code>eem</code>. For example, we can remove the second order scattering.</p>
<pre class="r"><code># Remove second order Rayleigh scattering
plot(eem_remove_scattering(eem, &quot;rayleigh&quot;, order = 2, width = 15))</code></pre>
<p><img src="/post/2019-06-14-eemr-1-0-0.en_files/figure-html/unnamed-chunk-6-1.png" width="768" /></p>
<pre class="r"><code># Extract Coble&#39; peaks
eem_coble_peaks(eem)</code></pre>
<pre><code>## Warning: This metric uses either excitation or emission wavelengths that
## were not present in the data. Data has been interpolated to fit the requested
## wavelengths.</code></pre>
<pre><code>##        sample  b        t        a       m        c
## 1 custom_cary NA 10.86736 83.44561 61.2534 49.55256</code></pre>
</div>
